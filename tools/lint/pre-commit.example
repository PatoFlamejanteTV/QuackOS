#!/usr/bin/env bash
# Exemplo de pre-commit hook para QuackOS
# Para usar, copie este arquivo para .git/hooks/pre-commit e torne-o execut√°vel:
#   cp tools/lint/pre-commit.example .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

echo "üîç Executando linters antes do commit..."

# Diret√≥rio do projeto
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Lista de arquivo modificados/adicionados
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$CHANGED_FILES" ]; then
    echo "‚úÖ Nenhum arquivo para verificar."
    exit 0
fi

# Flags para controlar quais linters executar
RUN_C_LINTER=false
RUN_ASM_LINTER=false
RUN_SHELL_LINTER=false
RUN_MARKDOWN_LINTER=false
RUN_MAKEFILE_LINTER=false

# Verifica quais tipos de arquivos foram modificados
while IFS= read -r file; do
    case "$file" in
        *.c|*.h|*.cpp|*.hpp)
            RUN_C_LINTER=true
            ;;
        *.asm|*.s|*.S)
            RUN_ASM_LINTER=true
            ;;
        *.sh)
            RUN_SHELL_LINTER=true
            ;;
        *.md)
            RUN_MARKDOWN_LINTER=true
            ;;
        Makefile|*.mk|GNUmakefile)
            RUN_MAKEFILE_LINTER=true
            ;;
    esac
done <<< "$CHANGED_FILES"

# Executa apenas os linters necess√°rios
FAILED=false

if [ "$RUN_C_LINTER" = true ]; then
    echo "  ‚Üí Verificando C/C++..."
    if ! ./tools/lint/lint-c.sh; then
        FAILED=true
    fi
fi

if [ "$RUN_ASM_LINTER" = true ]; then
    echo "  ‚Üí Verificando Assembly..."
    if ! ./tools/lint/lint-asm.sh; then
        FAILED=true
    fi
fi

if [ "$RUN_SHELL_LINTER" = true ]; then
    echo "  ‚Üí Verificando Shell Scripts..."
    if ! ./tools/lint/lint-shell.sh; then
        FAILED=true
    fi
fi

if [ "$RUN_MARKDOWN_LINTER" = true ]; then
    echo "  ‚Üí Verificando Markdown..."
    if ! ./tools/lint/lint-markdown.sh; then
        FAILED=true
    fi
fi

if [ "$RUN_MAKEFILE_LINTER" = true ]; then
    echo "  ‚Üí Verificando Makefiles..."
    if ! ./tools/lint/lint-makefile.sh; then
        FAILED=true
    fi
fi

if [ "$FAILED" = true ]; then
    echo ""
    echo "‚ùå Linting falhou! Corrija os erros antes de fazer commit."
    echo ""
    echo "üí° Dica: Para pular esta verifica√ß√£o (n√£o recomendado):"
    echo "   git commit --no-verify"
    exit 1
fi

echo "‚úÖ Todos os linters passaram!"
exit 0
