MEMORIA.md — Gerenciamento de Memória do QKern

Este documento define o modelo de memória física e virtual do kernel QKern no QuackOS.

Objetivos:

simplicidade

previsibilidade

compatibilidade com hardware antigo



---

Arquitetura

CPU: x86-64

Modo: long mode

Paging: 4 níveis (PML4)

Páginas: 4 KiB



---

Layout de Endereçamento Virtual

0x0000000000000000 ─┐
                     │ userspace
0x00007FFFFFFFFFFF ─┘

0xFFFF800000000000 ─┐
                     │ kernelspace
0xFFFFFFFFFFFFFFFF ─┘

Kernel mapeado em endereço alto

Userspace isolado



---

Memória Física

Detecção

Obtida via BIOS (INT 0x15, E820)

Passada ao kernel via boot_info


Estados possíveis

livre

reservada

usada



---

Alocador Físico

Estratégia

Bitmap simples

1 bit por página

Inicializado no boot


Funções:

void* pag_fis_alocar(void);
void pag_fis_liberar(void* pag);


---

Paging do Kernel

Mapeamento identity no início

Posterior remapeamento alto

Kernel sempre presente


Flags:

presente

leitura/escrita

supervisor



---

Heap do Kernel

Região virtual fixa

Crescimento linear

Sem paginação sob demanda


API:

void* kmalloc(long tam);
void kfree(void* ptr);


---

Memória de Processo

Cada processo possui:

espaço virtual próprio

tabela PML4 independente


Criação:

clonagem leve no forquilhar



---

mapear / desmapear

Syscalls implementam:

mapeamento anônimo

permissões básicas


Sem swap.


---

Proteções

Userspace não acessa kernel

Ponteiros inválidos causam erro



---

Testes Obrigatórios

alocação/liberação repetida

isolamento entre processos

page fault controlado



---

Documento normativo.